<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">

</head>
<body>
  <div class="dashboard">
    <h1>Admin Dashboard</h1>
    <button id="logoutBtn">Logout</button>

    <section>
      <h2>Teachers</h2>
      <div id="teacherList">Loading...</div>
    </section>

    <section>
      <h2>Students</h2>
      <div id="studentList">Loading...</div>
    </section>
  </div>

  <script type="module">
    import { auth, db } from "../js/firebase-config.js";
    import { logoutUser } from "../js/auth.js";
    import {
      collection, getDocs, updateDoc, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    document.getElementById("logoutBtn").addEventListener("click", logoutUser);

    async function loadUsers() {
      const teacherDiv = document.getElementById("teacherList");
      const studentDiv = document.getElementById("studentList");

      teacherDiv.innerHTML = "Loading...";
      studentDiv.innerHTML = "Loading...";

      const snapshot = await getDocs(collection(db, "users"));
      const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

      const teachers = users.filter(u => u.role === "teacher");
      const students = users.filter(u => u.role === "student");

      // ---- TEACHERS ----
      teacherDiv.innerHTML = "";
      for (const t of teachers) {
        const div = document.createElement("div");
        div.className = "user-card";

        const statusClass = t.status === "approved" ? "approved" : "pending";
        const statusText = t.status === "approved" ? "✅ Approved" : "⏳ Pending";

        div.innerHTML = `
          <p><b>Name:</b> ${t.name}</p>
          <p><b>Email:</b> ${t.email}</p>
          <p><b>Department:</b> ${t.department || "-"}</p>
          <p><b>Subject:</b> ${t.subject || "-"}</p>
          <p class="status ${statusClass}"><b>Status:</b> ${statusText}</p>
          <div>
            ${t.status === "pending" ? `<button data-id="${t.id}" class="approveBtn">Approve</button>` : ""}
            <button data-id="${t.id}" class="editBtn">Edit</button>
            <button data-id="${t.id}" class="deleteBtn">Delete</button>
          </div>
        `;
        teacherDiv.appendChild(div);
      }

      // ---- STUDENTS ----
      studentDiv.innerHTML = "";
      for (const s of students) {
        const div = document.createElement("div");
        div.className = "user-card";

        const statusClass = s.status === "approved" ? "approved" : "pending";
        const statusText = s.status === "approved" ? "✅ Approved" : "⏳ Pending";

        div.innerHTML = `
          <p><b>Name:</b> ${s.name}</p>
          <p><b>Email:</b> ${s.email}</p>
          <p class="status ${statusClass}"><b>Status:</b> ${statusText}</p>
          ${s.status === "pending" ? `<button data-id="${s.id}" class="approveBtn">Approve</button>` : ""}
        `;
        studentDiv.appendChild(div);
      }

      // Approve
      document.querySelectorAll(".approveBtn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const uid = e.target.dataset.id;
          await updateDoc(doc(db, "users", uid), { status: "approved" });
          alert("Approved successfully!");
          loadUsers();
        });
      });

      // Edit Teacher
      document.querySelectorAll(".editBtn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const uid = e.target.dataset.id;
          const newDept = prompt("Enter new department:");
          const newSubj = prompt("Enter new subject:");
          if (newDept || newSubj) {
            await updateDoc(doc(db, "users", uid), {
              department: newDept || "",
              subject: newSubj || ""
            });
            alert("Teacher details updated!");
            loadUsers();
          }
        });
      });

      // Delete Teacher
      document.querySelectorAll(".deleteBtn").forEach(btn => {
        btn.addEventListener("click", async e => {
          const uid = e.target.dataset.id;
          if (confirm("Delete this teacher?")) {
            await deleteDoc(doc(db, "users", uid));
            alert("Deleted successfully!");
            loadUsers();
          }
        });
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) loadUsers();
      else window.location.href = "../index.html";
    });
  </script>
</body>
</html>
